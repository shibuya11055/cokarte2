# ダッシュボード（最短価値）仕様書

## 目的
- ログイン後に業務状況を一目で把握し、次の行動へ最短で遷移できる画面を提供する。
- 初回実装は「指標の可視化」と「直近リスト」「簡易リマインド」に絞る。

## スコープ（今回に含む）
- KPI 4点の表示（当月基準）
  - 顧客数/上限、今月売上、今月来店数、平均客単価
- 直近の活動リスト
  - 直近のカルテ5件、直近の新規顧客5件
- リマインド/アラート（簡易版）
  - 30日以内に誕生日の顧客、要フォロー顧客（最終来店6ヶ月以上空き）、金額未入力のカルテ（直近30日）、写真未添付のカルテ（直近30日）
- 最小限のUI構成とルーティング

（スコープ外：グラフの描画、詳細な分析、通知配送、エクスポート）

## 対象ユーザー / 権限
- `current_user` でログイン済のユーザー。全データは当該ユーザー配下に限定する。

## ルーティング
- `GET /dashboard` → `DashboardController#show`
- サイドメニューに「ダッシュボード」リンクを追加（ログイン時のみ表示）

## データモデルと前提
- 顧客: `User has_many :clients`
- カルテ: `Client has_many :client_records`、`ClientRecord`に`visited_at`, `amount`, `note`, `photos(ActiveStorage)`
- プラン上限: `PlanQuota`（`client_limit`, `photos_per_record`, `remaining_clients`）

## KPI 定義（当月集計）
- 顧客数/上限
  - 顧客数: `current_user.clients.count`
  - 上限: `current_user.client_limit`（`nil`は無制限。表示は `∞`）
- 今月売上: `ClientRecord.amount` の当月合計（`nil`は除外）
- 今月来店数: 当月の `ClientRecord.visited_at` 件数
- 平均客単価: 今月売上 ÷ 今月来店数（0件は `-` 表示）

### 参照クエリ（概念）
```ruby
records = ClientRecord.joins(:client).where(clients: { user_id: current_user.id })
month_range = Time.zone.now.all_month

revenue_this_month = records.where(visited_at: month_range).where.not(amount: nil).sum(:amount)
visits_this_month  = records.where(visited_at: month_range).count
avg_unit_price     = visits_this_month.positive? ? (revenue_this_month.to_f / visits_this_month).floor : nil

clients_count      = current_user.clients.count
client_limit       = current_user.client_limit # nil 可
```

## 直近の活動リスト
- 直近カルテ5件
  - 項目: 日時（`visited_at`）、顧客氏名、金額（`¥`/0桁）、ノート抜粋（30文字）、詳細リンク
  - 取得: `records.order(visited_at: :desc).limit(5)`（`visited_at`が無い場合は`created_at`降順をフォールバック）
- 直近の新規顧客5件
  - 項目: 作成日、氏名、詳細リンク
  - 取得: `current_user.clients.order(created_at: :desc).limit(5)`

## リマインド/アラート（簡易）
- 30日以内に誕生日
  - 抽出: `birthday` の月日が今日から30日先までに含まれる顧客
  - 表示: 氏名、誕生日（月日）
- 要フォロー顧客（休眠）
  - 定義: 最終来店（`MAX(visited_at)`）が6ヶ月より前、またはカルテなし
  - 表示: 氏名、最終来店日（`-` 可）
- 金額未入力のカルテ（直近30日）
  - 抽出: `records.where(amount: nil).where('visited_at >= ?', 30.days.ago)`
  - 表示: 日時、顧客、詳細リンク
- 写真未添付のカルテ（直近30日）
  - 抽出: `records.left_outer_joins(:photos_attachments).where(active_storage_attachments: { id: nil }).where('visited_at >= ?', 30.days.ago)`
  - 表示: 日時、顧客、詳細リンク

### 参照クエリ（概念）
```ruby
# 誕生日もうすぐ（PG想定、年は無視）
today = Time.zone.today
from  = today.strftime('%m%d')
to    = (today + 30).strftime('%m%d')
upcoming_birthdays = current_user.clients
  .where("to_char(birthday, 'MMDD') BETWEEN ? AND ?", from, to)
  .order(Arel.sql("to_char(birthday, 'MMDD')"))
  .limit(10)

# 要フォロー（最終来店6ヶ月以上）
stale_since = 6.months.ago
last_visits = records
  .group(:client_id)
  .maximum(:visited_at) # { client_id => last_time }
# 表示側で last_time.blank? || last_time < stale_since を抽出（最大10件）
```

## UI 構成（ワイヤー案）
- 上段: KPIカード4枚（横並び、モバイルは2列×2）
- 中段: 左「直近カルテ5件」／右「新規顧客5件」
- 下段: 「リマインド/アラート」リスト（各最大10件、空ならプレースホルダ）
- 各行に「詳細」などのクイックリンクを配置

## 空状態 / エラー時の表示
- KPI: 該当0件は `-`、無制限上限は `∞`
- リスト: 0件時は「該当なし」をプレーンテキスト表示
- 金額フォーマット: `number_to_currency(amount, unit: '¥', precision: 0)`

## パフォーマンス / N+1
- 一覧は最大5〜10件に制限
- 直近カルテは `includes(:client)` で顧客情報のN+1回避
- 集計は当月・直近30日など期間を絞る

## セキュリティ
- すべてのクエリを `current_user` 配下に限定
- コントローラは `before_action :authenticate_user!` 前提

## 受け入れ条件（AC）
1. ログイン後、`/dashboard` でページが表示される
2. KPI 4点が表示され、値が存在しない場合でも崩れない
3. 直近カルテ5件・新規顧客5件が表示され、リンクで詳細へ遷移できる
4. リマインド4種のいずれかで該当があれば表示、なければ空状態表示
5. 自分以外のユーザーのデータは一切表示されない
6. サイドメニューからダッシュボードへ遷移可能

## 実装メモ（次ステップ）
- ルート: `get 'dashboard', to: 'dashboard#show'`
- コントローラ: `DashboardController#show` にて上記インスタンス変数を準備
- ビュー: `app/views/dashboard/show.html.erb` にKPIカード、リスト、リマインドを配置
- メニュー: `layouts/_side_menu.html.erb` にリンク追加

## 将来拡張（次フェーズ候補）
- グラフ（12ヶ月の売上/来店数推移）
- 期間切替（今週/今月/四半期）
- 休眠顧客の自動抽出ルール調整、フォロータスク化
- エクスポート/印刷、ウィジェット化

