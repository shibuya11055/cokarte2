# 課金プランと実装計画（設計書）

本書は、顧客数ベースの料金プラン導入と画像コスト最適化（アップロード時リサイズ）を最小構成で実装するための計画をまとめたもの。

## 方針
- 料金判定は「顧客登録数」のみで行う（保存容量の制限は今回は入れない）
- 課金は Stripe Checkout + Webhook + Customer Portal の最小構成
- 画像はアップロード時に縮小・圧縮して保存し、S3コストを最適化
- Solid Queue は使わず本番は `:async` のまま（将来切替可）

## プラン（初期）
- Free: 顧客 50 人まで / 画像は1枚/カルテ（¥0）
- Basic: 顧客 150 人まで / 画像は3枚/カルテ（¥1,500/月）
- Pro: 顧客上限なし / 画像は3枚/カルテ（¥2,480/月）

将来的に容量・帯域の上限/課金は拡張予定（今回のスコープ外）。

---

## コミット計画（小さく分割）

1. users にプラン情報 + 顧客数キャッシュ
   - Migration: `users.plan_tier:string default:"free"`, `users.clients_count:integer default:0 not null`
   - `Client` に `belongs_to :user, counter_cache: true`
   - Backfill: 既存ユーザーごとに `clients_count` を集計
   - 受入: `plan_tier=free` で起動、顧客数が正しく反映

2. 顧客数クォータ + 画像上限（free=50 / basic=150 / pro=∞、画像: Free=1 / Basic=3 / Pro=3）
   - `User` に上限ヘルパー（`client_limit` / `remaining_clients` / `photos_per_record`）
   - `ClientsController#create` で `before_action :ensure_client_quota!`
   - `ClientRecord` の画像バリデーションを動的に（`user.photos_per_record` を参照）
   - 受入: freeで51件目の作成不可。画像はプランに応じて1/3枚の上限が効く

3. 上限バッジ + アップグレード導線
   - `layouts/application.html.erb` に「顧客 X/上限 Y」バッジ
   - 80%超で注意、上限到達で「プラン変更」ボタン
   - 受入: 主要画面で現在値が常に見える

4. Stripe 導入の下準備
   - 依存: `stripe` gem、`config/initializers/stripe.rb`（`STRIPE_SECRET_KEY`）
   - 受入: ENV 未設定でも起動

5. Checkout エンドポイント（最小）
   - `POST /billing/checkout?plan=basic|pro`
   - 価格IDは ENV: `STRIPE_PRICE_BASIC`, `STRIPE_PRICE_PRO`
   - `APP_BASE_URL` を使って success/cancel URL を設定
   - 受入: ボタン押下で Stripe の決済画面へ遷移

6. Webhook でプラン同期
   - `POST /stripe/webhook`
   - `checkout.session.completed` → `users.stripe_customer_id` 保存
   - `customer.subscription.updated|deleted` → `plan_tier` / `subscription_status` 更新
   - 検証: `STRIPE_WEBHOOK_SECRET` で署名検証
   - 受入: テストイベントで plan 切替が反映

7. Customer Portal
   - `POST /billing/portal`（カード変更/解約）
   - 受入: Portal に遷移できる

8. 料金ページ（簡易）
   - `GET /pricing`（Free: 50名/画像1枚、Basic: 150名/画像3枚、Pro: 無制限/画像3枚 の説明とボタン）
   - 受入: 導線が明確

9. 画像のアップロード時リサイズ/圧縮（コスト最適化）
   - `attach_files_with_custom_key` を拡張
     - 最大辺 1600px / JPEG 品質 80 / auto-orient / EXIF 基本 strip
     - 可能なら vips、fallback で MiniMagick（dev/test は MiniMagick でも可）
     - 変換後の content_type / 拡張子に合わせて保存
   - 受入: S3 保存サイズが縮小し、表示に影響しない

10. エラーメッセージ/通知の微修正
    - 上限到達などの日本語メッセージの統一
    - フラッシュ/バリデーション整え

11. 利用規約・プライバシーポリシー・特商法ページ
    - ルート: `GET /terms` / `GET /privacy` / `GET /legal`
    - ビュー雛形（ドラフト）を配置
      - 利用規約: サービス概要、アカウント、禁止行為、課金、解約、免責、準拠法/裁判管轄、改定
      - プライバシーポリシー: 取得情報（氏名/メール/画像等）、利用目的、第三者提供（S3/Stripe等）、保存期間、安全管理、開示/削除、連絡先
      - 特商法: 事業者情報、価格、支払時期、提供時期、解約・返金、追加料金（通信費等）
    - フッター/ヘッダーにリンクを追加
    - 受入: 公開・リンク到達可能

12. Checkout で同意の取得
    - Stripe ダッシュボードで規約/PP の URL を設定
    - Checkout セッションに consent_collection を有効化（ToS/PP 同意）
    - 受入: Checkoutに同意チェックが表示

13. ドキュメント/ENV 整備
    - README または docs に ENV 一覧とセットアップ手順
    - Stripe CLI による webhook 検証手順

---

## 環境変数（本番 Render）
- Stripe
  - `STRIPE_SECRET_KEY`
  - `STRIPE_WEBHOOK_SECRET`
  - `STRIPE_PRICE_BASIC`（¥1,500/月の price ID）
  - `STRIPE_PRICE_PRO`（¥2,480/月の price ID）
  - `APP_BASE_URL`（例: `https://cokarte.onrender.com`）
- S3（既存）
  - `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION=ap-northeast-1`, `AWS_S3_BUCKET`

- ## 受け入れ観点（抜粋）
- Free で 51 件目が作成不可・メッセージ表示（Basic=150 まで、Proは無制限）
- Checkout → success → Webhook で plan 切替が即時反映
- Portal で解約 → plan が free に戻る
- 画像アップロード後、S3 オブジェクトがリサイズ/圧縮されている
- 画像上限: Freeは1枚/カルテ、Basic/Proは3枚/カルテが適用される
- 規約/PP/特商法ページにリンクで到達可能

## 今後の拡張（今回のスコープ外）
- 保存容量・帯域に基づくクォータ/超過課金
- CloudFront + OAC で配信コスト最適化
- Solid Queue の本番運用（別DBマイグレーション）
- チーム/アカウント単位課金（ユーザー管理拡張）
