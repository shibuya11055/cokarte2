<%# filepath: app/views/client_records/index.html.erb %>
<h1>カルテ一覧</h1>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
  <form method="get" action="<%= client_records_path %>" class="client-search-form" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 0;">
    <input type="text" name="q" value="<%= params[:q] %>" placeholder="顧客氏名で検索" style="padding: 0.6rem 1rem; border-radius: 6px; border: 1px solid #b2dfdb; min-width: 220px; font-size: 1rem;">
    <button type="submit" class="btn btn-detail">検索</button>
    <% if params[:q].present? %>
      <%= link_to 'クリア', client_records_path, class: 'btn' %>
    <% end %>
  </form>
  <%= link_to 'カルテ作成', new_client_record_path, class: 'btn btn-detail', style: 'white-space: nowrap;' %>
</div>

<table class="client-records-table">
  <thead>
    <tr>
      <th>
        <%= link_to '日付', client_records_path(q: params[:q], sort: params[:sort] == 'visited_at_desc' ? 'visited_at_asc' : 'visited_at_desc'), class: (params[:sort]&.start_with?('visited_at') ? 'active-sort' : '') %>
        <% if params[:sort] == 'visited_at_desc' %>▼<% elsif params[:sort] == 'visited_at_asc' %>▲<% end %>
      </th>
      <th>顧客氏名</th>
      <th>
        <%= link_to '金額', client_records_path(q: params[:q], sort: params[:sort] == 'amount_desc' ? 'amount_asc' : 'amount_desc'), class: (params[:sort]&.start_with?('amount') ? 'active-sort' : '') %>
        <% if params[:sort] == 'amount_desc' %>▼<% elsif params[:sort] == 'amount_asc' %>▲<% end %>
      </th>
      <th>ノート</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <% @client_records.each do |record| %>
      <tr>
        <td><%= record.visited_at&.strftime('%Y/%m/%d %H:%M') %></td>
        <td><%= record.client&.last_name.to_s + record.client&.first_name.to_s %></td>
        <td><%= number_to_currency(record.amount, unit: '¥', precision: 0) if record.amount %></td>
        <td><%= record.note.to_s.length > 30 ? record.note.to_s[0,30] + '...' : record.note.to_s %></td>
        <td>
          <%= link_to '詳細', client_record_path(record), class: 'btn btn-detail' %>
          <%= link_to '編集', edit_client_record_path(record), class: 'btn btn-detail' %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
<div class="pagination">
  <%= paginate @client_records %>
</div>
